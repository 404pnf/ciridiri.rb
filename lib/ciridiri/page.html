<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8" />
  <title>page.rb</title>
  <link rel="stylesheet" href="http://vast.github.com/rokko/assets/v0.1.2/docco.css" />
         <link rel="stylesheet" href="http://vast.github.com/rokko/assets/v0.1.2/highlight.css" />
  <script src="http://vast.github.com/rokko/assets/v0.1.2/highlight.pack.js"></script>
<script>hljs.initHighlightingOnLoad();</script>

</head>
<body>
<div id="container">
  <div id="background"></div>
  <div id="jump_to">
    Jump To &hellip;
    <div id="jump_wrapper">
      <div id="jump_page">
          <a class="source" href="../../index.html">index</a>
          <a class="source" href="../ciridiri.html">ciridiri.rb</a>
          <a class="source" href="./extensions.html">extensions.rb</a>
          <a class="source" href="./finders.html">finders.rb</a>
          <a class="source" href="./page.html">page.rb</a>
          <a class="source" href="./paths.html">paths.rb</a>
      </div>
    </div>
  </div>
  <table cellspacing="0" cellpadding="0">
  <thead>
    <tr>
      <th class="docs"><h1>page.rb</h1></th>
      <th class="code"></th>
    </tr>
  </thead>
  <tbody>
    <tr id="section-1">
      <td class="docs">
        <div class="pilwrap">
          <a class="pilcrow" href="#section-1">&#182;</a>
        </div>
        
      </td>
      <td class="code">
        <pre class="ruby"><code>require 'fileutils'
dir = File.dirname(__FILE__)
%w[finders paths extensions].each {|r| require File.join(dir, r)}

module Ciridiri
  class Page
    extend Ciridiri::Finders, Ciridiri::Paths</code></pre>
      </td>
    </tr>
    <tr id="section-2">
      <td class="docs">
        <div class="pilwrap">
          <a class="pilcrow" href="#section-2">&#182;</a>
        </div>
        <h2>Constants block</h2>
      </td>
      <td class="code">
        <pre class="ruby"><code></code></pre>
      </td>
    </tr>
    <tr id="section-3">
      <td class="docs">
        <div class="pilwrap">
          <a class="pilcrow" href="#section-3">&#182;</a>
        </div>
        <p>A regular expression for markdown like headers (<code>#</code>, <code>##</code>, <code>###</code>, <code>=====</code>, <code>----</code>)</p>
      </td>
      <td class="code">
        <pre class="ruby"><code>    MD_TITLE = Regexp.new(&quot;(^\#{1,3}\\s*?([^#].*?)#*$)|(^ {0,3}(\\S.*?)\\n(?:=|-)+(?=\\n+|\\Z))&quot;, Regexp::MULTILINE)</code></pre>
      </td>
    </tr>
    <tr id="section-4">
      <td class="docs">
        <div class="pilwrap">
          <a class="pilcrow" href="#section-4">&#182;</a>
        </div>
        <p>HTML headers (<code>&lt;h1-3&gt;</code>)</p>
      </td>
      <td class="code">
        <pre class="ruby"><code>    HTML_TITLE = Regexp.new(&quot;^&lt;h[1-3](.*)?&gt;((.*)+)&lt;/h[1-3]&gt;&quot;)
</code></pre>
      </td>
    </tr>
    <tr id="section-5">
      <td class="docs">
        <div class="pilwrap">
          <a class="pilcrow" href="#section-5">&#182;</a>
        </div>
        <p>File extensions</p>
      </td>
      <td class="code">
        <pre class="ruby"><code>    SOURCE_FILE_EXT = &quot;.text&quot;.freeze
    CACHED_FILE_EXT = &quot;.html&quot;.freeze
</code></pre>
      </td>
    </tr>
    <tr id="section-6">
      <td class="docs">
        <div class="pilwrap">
          <a class="pilcrow" href="#section-6">&#182;</a>
        </div>
        <h2>Default values for all options</h2>
      </td>
      <td class="code">
        <pre class="ruby"><code></code></pre>
      </td>
    </tr>
    <tr id="section-7">
      <td class="docs">
        <div class="pilwrap">
          <a class="pilcrow" href="#section-7">&#182;</a>
        </div>
        <p>Where pages should be stored on a file system</p>
      </td>
      <td class="code">
        <pre class="ruby"><code>    @@content_dir = '.'</code></pre>
      </td>
    </tr>
    <tr id="section-8">
      <td class="docs">
        <div class="pilwrap">
          <a class="pilcrow" href="#section-8">&#182;</a>
        </div>
        <p>Should we create backups (<code>filename.1278278364.text</code>, where <code>1278278364</code> &mdash; current timestamp) or not.
Useful when you are not going to place <code>@@content_dir</code> under version control</p>
      </td>
      <td class="code">
        <pre class="ruby"><code>    @@backups = false</code></pre>
      </td>
    </tr>
    <tr id="section-9">
      <td class="docs">
        <div class="pilwrap">
          <a class="pilcrow" href="#section-9">&#182;</a>
        </div>
        <p>Page fragments (formatted file <code>contents</code>) caching</p>
      </td>
      <td class="code">
        <pre class="ruby"><code>    @@caching = true
</code></pre>
      </td>
    </tr>
    <tr id="section-10">
      <td class="docs">
        <div class="pilwrap">
          <a class="pilcrow" href="#section-10">&#182;</a>
        </div>
        <h3>Formatter block</h3>
      </td>
      <td class="code">
        <pre class="ruby"><code></code></pre>
      </td>
    </tr>
    <tr id="section-11">
      <td class="docs">
        <div class="pilwrap">
          <a class="pilcrow" href="#section-11">&#182;</a>
        </div>
        <p>You can use any formatter. For example:</p>

<p>Bluecloth:</p>

<pre><code>require 'bluecloth'
Page.formatter = lambda {|text| Bluecloth.new(text).to_html)}
</code></pre>

<p>RDiscount:</p>

<pre><code>require 'rdiscount'
Page.formatter = lambda {|text| RDiscount.new(text).to_html)}
</code></pre>

<p>Rutils with RDiscount:</p>

<pre><code>require 'rutils'
require 'rdiscount'
Page.formatter = lambda {|text| RuTils::Gilenson::Formatter.new(RDiscount.new(text).to_html).to_html}
</code></pre>

<p>HTML escaping:</p>

<pre><code>Page.formatter = {|text| "&lt;pre&gt;#{Rack::Utils.escape_html(text)}&lt;/pre&gt;"}
</code></pre>
      </td>
      <td class="code">
        <pre class="ruby"><code>    @@formatter = lambda {|text| text}
</code></pre>
      </td>
    </tr>
    <tr id="section-12">
      <td class="docs">
        <div class="pilwrap">
          <a class="pilcrow" href="#section-12">&#182;</a>
        </div>
        <p>Define attr_reader/accessors</p>
      </td>
      <td class="code">
        <pre class="ruby"><code>    attr_accessor :title, :contents
    attr_reader :path, :uri
</code></pre>
      </td>
    </tr>
    <tr id="section-13">
      <td class="docs">
        <div class="pilwrap">
          <a class="pilcrow" href="#section-13">&#182;</a>
        </div>
        <p>Class level attr_accessors. We use them for configuring: <code>Page.content_dir = '/tmp'</code></p>
      </td>
      <td class="code">
        <pre class="ruby"><code>    cattr_accessor :content_dir, :backups, :caching, :formatter
</code></pre>
      </td>
    </tr>
    <tr id="section-14">
      <td class="docs">
        <div class="pilwrap">
          <a class="pilcrow" href="#section-14">&#182;</a>
        </div>
        <h2>Public methods</h2>
      </td>
      <td class="code">
        <pre class="ruby"><code></code></pre>
      </td>
    </tr>
    <tr id="section-15">
      <td class="docs">
        <div class="pilwrap">
          <a class="pilcrow" href="#section-15">&#182;</a>
        </div>
        <p>Convert <code>uri</code> to <code>path</code>, find the <code>title</code> in <code>contents</code></p>
      </td>
      <td class="code">
        <pre class="ruby"><code>    def initialize(uri, contents)
      @path, @uri, @title, @contents = Page.path_from_uri(uri), uri, Page.find_title(contents), contents
    end
</code></pre>
      </td>
    </tr>
    <tr id="section-16">
      <td class="docs">
        <div class="pilwrap">
          <a class="pilcrow" href="#section-16">&#182;</a>
        </div>
        <p>Create needed directory hierarchy and backup the file if needed.
Write <code>@contents</code> to the file and return <code>true</code> or <code>false</code> if
any error occured</p>
      </td>
      <td class="code">
        <pre class="ruby"><code>    def save
      FileUtils.mkdir_p(File.dirname(@path)) unless File.exists?(@path)
      backup if Page.backups? &amp;&amp; File.exists?(@path)

      begin
        File.open(@path, &quot;w&quot;) {|f| f.write(@contents)}
        true
      rescue StandardError
        false
      end
    end
</code></pre>
      </td>
    </tr>
    <tr id="section-17">
      <td class="docs">
        <div class="pilwrap">
          <a class="pilcrow" href="#section-17">&#182;</a>
        </div>
        <p>Save <code>@contents</code> formatted with <code>Page.formatter</code> to the cache file
<code>index.text</code> &ndash;> <code>index.text.html</code></p>
      </td>
      <td class="code">
        <pre class="ruby"><code>    def cache!
      File.open(@path + CACHED_FILE_EXT, 'w') {|f| f.write(@@formatter.call(@contents))}
    end
</code></pre>
      </td>
    </tr>
    <tr id="section-18">
      <td class="docs">
        <div class="pilwrap">
          <a class="pilcrow" href="#section-18">&#182;</a>
        </div>
        <p>Delete the cache file</p>
      </td>
      <td class="code">
        <pre class="ruby"><code>    def sweep!
      File.delete(@path + CACHED_FILE_EXT)
    end
</code></pre>
      </td>
    </tr>
    <tr id="section-19">
      <td class="docs">
        <div class="pilwrap">
          <a class="pilcrow" href="#section-19">&#182;</a>
        </div>
        <p>Return an array of the page revisions</p>
      </td>
      <td class="code">
        <pre class="ruby"><code>    def revisions
      @revisions ||= find_revisions
    end
</code></pre>
      </td>
    </tr>
    <tr id="section-20">
      <td class="docs">
        <div class="pilwrap">
          <a class="pilcrow" href="#section-20">&#182;</a>
        </div>
        <p>Return <code>@contents</code> HTML representation.
If a page fragments caching enabled (<code>Page.caching = true</code>) then
regenerate the fragment cache (<code>index.text.html</code>) if needed (it&rsquo;s outdated or doesn&rsquo;t exist)
and return the cached contents.
Otherwise (<code>Page.caching = false</code>) return <code>@contents</code> formatted with <code>Page.formatter</code></p>
      </td>
      <td class="code">
        <pre class="ruby"><code>    def to_html
      if Page.caching?
        cached = @path + CACHED_FILE_EXT
        cache! if !File.exists?(cached) || File.mtime(@path) &gt; File.mtime(cached)

        File.open(cached).read
      else
        @@formatter.call(@contents)
      end
    end
</code></pre>
      </td>
    </tr>
    <tr id="section-21">
      <td class="docs">
        <div class="pilwrap">
          <a class="pilcrow" href="#section-21">&#182;</a>
        </div>
        <p>Tiny <code>attr_writer</code> for <code>@@content_dir</code> which creates the content directory if it doesn&rsquo;t exist</p>
      </td>
      <td class="code">
        <pre class="ruby"><code>    def self.content_dir=(dir)
      @@content_dir = dir
      begin
        FileUtils.mkdir_p(@@content_dir) if !File.exists?(@@content_dir)
      rescue Errno::EACCES</code></pre>
      </td>
    </tr>
    <tr id="section-22">
      <td class="docs">
        <div class="pilwrap">
          <a class="pilcrow" href="#section-22">&#182;</a>
        </div>
        <p>Can&rsquo;t create content dir, using current working dir</p>
      </td>
      <td class="code">
        <pre class="ruby"><code>        @@content_dir = &quot;.&quot;
      end
    end
</code></pre>
      </td>
    </tr>
    <tr id="section-23">
      <td class="docs">
        <div class="pilwrap">
          <a class="pilcrow" href="#section-23">&#182;</a>
        </div>
        <h2>Protected methods</h2>
      </td>
      <td class="code">
        <pre class="ruby"><code>
    protected</code></pre>
      </td>
    </tr>
    <tr id="section-24">
      <td class="docs">
        <div class="pilwrap">
          <a class="pilcrow" href="#section-24">&#182;</a>
        </div>
        <p>Find the title in contents (html or markdown variant).
Return <code>""</code> if nothing found.</p>
      </td>
      <td class="code">
        <pre class="ruby"><code>    def self.find_title(contents=&quot;&quot;)
      if contents.match(MD_TITLE)
        $2.strip || $4.strip
      elsif contents.match(HTML_TITLE)
        $2.strip
      else
        &quot;&quot;
      end
    end
</code></pre>
      </td>
    </tr>
    <tr id="section-25">
      <td class="docs">
        <div class="pilwrap">
          <a class="pilcrow" href="#section-25">&#182;</a>
        </div>
        <p>Collect only timestamps of revisions.
<code>index.1273434670.text</code>, <code>index.1273434450.text</code> &ndash;> <code>["1273434670", "1273434450"]</code></p>
      </td>
      <td class="code">
        <pre class="ruby"><code>    def find_revisions
      Dir.chdir(File.dirname(@path)) do
        basename = File.basename(@path, SOURCE_FILE_EXT)
        Dir.glob(basename + &quot;.*&quot; + SOURCE_FILE_EXT).
                collect {|f| File.basename(f, SOURCE_FILE_EXT).sub(basename, '')}
      end
    end
</code></pre>
      </td>
    </tr>
    <tr id="section-26">
      <td class="docs">
        <div class="pilwrap">
          <a class="pilcrow" href="#section-26">&#182;</a>
        </div>
        <p>Backup the file by copying it&rsquo;s current version to the same file but with the current timestamp.
<code>index.text</code> &ndash;> <code>index.1273434670.text</code></p>

      </td>
      <td class="code">
        <pre class="ruby"><code>    def backup
      FileUtils.cp(@path, @path.sub(Regexp.new(&quot;#{SOURCE_FILE_EXT}$&quot;), &quot;.#{Time.now.to_i.to_s}#{SOURCE_FILE_EXT}&quot;))
    end
    
  end
end</code></pre>
      </td>
    </tr>
  </tbody>
  </table>
</div>
</body>
</html>
